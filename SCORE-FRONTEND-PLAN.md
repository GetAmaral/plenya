# Score System - Frontend Development Plan

**Date:** January 24, 2026
**Status:** ðŸš§ In Progress - Phase 1

---

## Overview

Build a complete Score Management system with:
1. **Backend API** - Full CRUD operations for score hierarchy
2. **Management Interface** - Admin UI for editing score data
3. **Mindmap Visualization** - Interactive visual representation using React Flow

---

## Architecture Summary

### Score System Hierarchy (4 Levels)

```
ScoreGroup (e.g., "Hemograma Completo")
    â””â”€ ScoreSubgroup (e.g., "SÃ©rie Vermelha")
        â””â”€ ScoreItem (e.g., "Hemoglobina - Homens", 20 points)
            â””â”€ ScoreLevel (6 risk levels: 0-5)
                â”œâ”€ Level 0: Critical (worst)
                â”œâ”€ Level 1: Very Low/High
                â”œâ”€ Level 2: Suboptimal or Extreme Opposite
                â”œâ”€ Level 3: Borderline
                â”œâ”€ Level 4: Good (normal range)
                â””â”€ Level 5: Optimal (functional medicine target)
```

### Key Features
- UUID v7 for all entities
- Soft deletes + CASCADE constraints
- Order field for display sorting
- Self-referencing ScoreItem (hierarchical support)
- Flexible operators: `=, >, >=, <, <=, between`
- U-shaped curves support (extremes can be pathological)
- Points system (0-100) per item
- Unit conversion tracking

### Source of Truth
- **Go Models:** `apps/api/internal/models/score_*.go` (NEVER edit generated files)
- **Migrations:** Auto-generated by Atlas from Go models
- **TypeScript Types:** Auto-generated from OpenAPI/Swagger
- **Zod Schemas:** Auto-generated for form validation

---

## Phase 1: Backend API (Go) ðŸŽ¯ CURRENT

### 1.1 Repository Layer

**File:** `apps/api/internal/repository/score_repository.go`

**Methods:**
```go
// ScoreGroup
CreateScoreGroup(group *models.ScoreGroup) error
GetScoreGroupByID(id uuid.UUID) (*models.ScoreGroup, error)
GetAllScoreGroups() ([]models.ScoreGroup, error)
UpdateScoreGroup(group *models.ScoreGroup) error
DeleteScoreGroup(id uuid.UUID) error

// ScoreSubgroup
CreateScoreSubgroup(subgroup *models.ScoreSubgroup) error
GetScoreSubgroupByID(id uuid.UUID) (*models.ScoreSubgroup, error)
GetSubgroupsByGroupID(groupID uuid.UUID) ([]models.ScoreSubgroup, error)
UpdateScoreSubgroup(subgroup *models.ScoreSubgroup) error
DeleteScoreSubgroup(id uuid.UUID) error

// ScoreItem
CreateScoreItem(item *models.ScoreItem) error
GetScoreItemByID(id uuid.UUID) (*models.ScoreItem, error)
GetItemsBySubgroupID(subgroupID uuid.UUID) ([]models.ScoreItem, error)
UpdateScoreItem(item *models.ScoreItem) error
DeleteScoreItem(id uuid.UUID) error

// ScoreLevel
CreateScoreLevel(level *models.ScoreLevel) error
GetScoreLevelByID(id uuid.UUID) (*models.ScoreLevel, error)
GetLevelsByItemID(itemID uuid.UUID) ([]models.ScoreLevel, error)
UpdateScoreLevel(level *models.ScoreLevel) error
DeleteScoreLevel(id uuid.UUID) error

// Special: Nested queries
GetScoreGroupTree(id uuid.UUID) (*models.ScoreGroup, error) // With all nested data
GetAllScoreGroupTrees() ([]models.ScoreGroup, error)         // Full hierarchy
```

### 1.2 Service Layer

**File:** `apps/api/internal/services/score_service.go`

**Responsibilities:**
- Business logic validation
- Order management (auto-increment, reordering)
- Cascade operations (delete group â†’ delete subgroups â†’ delete items â†’ delete levels)
- Tree building for nested responses
- Authorization checks (admin only for mutations)

**Methods:**
```go
// CRUD with business logic
CreateGroup(dto CreateScoreGroupDTO) (*models.ScoreGroup, error)
UpdateGroup(id uuid.UUID, dto UpdateScoreGroupDTO) (*models.ScoreGroup, error)
DeleteGroup(id uuid.UUID) error
GetGroupTree(id uuid.UUID) (*ScoreGroupTreeDTO, error)
GetAllGroupTrees() ([]ScoreGroupTreeDTO, error)

// Similar for subgroups, items, levels
// ...

// Special operations
ReorderGroups(orderMap map[uuid.UUID]int) error
ReorderSubgroups(groupID uuid.UUID, orderMap map[uuid.UUID]int) error
EvaluateScore(itemID uuid.UUID, value float64) (*models.ScoreLevel, error) // Future: evaluate patient values
```

### 1.3 HTTP Handlers

**File:** `apps/api/internal/handlers/score_handler.go`

**Endpoints:**

#### ScoreGroup Endpoints
```
GET    /api/v1/score-groups                    # List all groups (ordered)
GET    /api/v1/score-groups/:id                # Get single group
GET    /api/v1/score-groups/:id/tree           # Get group with nested subgroups/items/levels
POST   /api/v1/score-groups                    # Create group (admin only)
PUT    /api/v1/score-groups/:id                # Update group (admin only)
DELETE /api/v1/score-groups/:id                # Soft delete group (admin only)
POST   /api/v1/score-groups/reorder            # Reorder groups (admin only)
```

#### ScoreSubgroup Endpoints
```
GET    /api/v1/score-subgroups                 # List all subgroups
GET    /api/v1/score-subgroups/:id             # Get single subgroup
GET    /api/v1/score-groups/:groupId/subgroups # Get subgroups by group
POST   /api/v1/score-subgroups                 # Create subgroup (admin only)
PUT    /api/v1/score-subgroups/:id             # Update subgroup (admin only)
DELETE /api/v1/score-subgroups/:id             # Soft delete subgroup (admin only)
```

#### ScoreItem Endpoints
```
GET    /api/v1/score-items                     # List all items
GET    /api/v1/score-items/:id                 # Get single item with levels
GET    /api/v1/score-subgroups/:subgroupId/items # Get items by subgroup
POST   /api/v1/score-items                     # Create item (admin only)
PUT    /api/v1/score-items/:id                 # Update item (admin only)
DELETE /api/v1/score-items/:id                 # Soft delete item (admin only)
```

#### ScoreLevel Endpoints
```
GET    /api/v1/score-levels                    # List all levels
GET    /api/v1/score-levels/:id                # Get single level
GET    /api/v1/score-items/:itemId/levels      # Get levels by item
POST   /api/v1/score-levels                    # Create level (admin only)
PUT    /api/v1/score-levels/:id                # Update level (admin only)
DELETE /api/v1/score-levels/:id                # Soft delete level (admin only)
```

#### Special Endpoints
```
GET    /api/v1/score-groups/tree               # Get ALL groups with full nested data (for mindmap)
POST   /api/v1/score-items/:id/evaluate        # Evaluate patient value â†’ return level (future)
```

**Swagger Annotations:**
- Full OpenAPI spec for all endpoints
- Request/Response schemas
- Authentication requirements (JWT)
- Example values

### 1.4 Route Registration

**File:** `apps/api/cmd/server/main.go`

```go
// Score routes (admin only for mutations)
scoreGroup := api.Group("/score-groups")
scoreGroup.Get("/", handlers.GetAllScoreGroups)
scoreGroup.Get("/tree", handlers.GetAllScoreGroupTrees)
scoreGroup.Get("/:id", handlers.GetScoreGroupByID)
scoreGroup.Get("/:id/tree", handlers.GetScoreGroupTree)
scoreGroup.Post("/", middleware.RequireAuth, middleware.RequireRole("admin"), handlers.CreateScoreGroup)
scoreGroup.Put("/:id", middleware.RequireAuth, middleware.RequireRole("admin"), handlers.UpdateScoreGroup)
scoreGroup.Delete("/:id", middleware.RequireAuth, middleware.RequireRole("admin"), handlers.DeleteScoreGroup)
scoreGroup.Post("/reorder", middleware.RequireAuth, middleware.RequireRole("admin"), handlers.ReorderScoreGroups)

// Similar for subgroups, items, levels
// ...
```

### 1.5 Auto-Generation

After implementing backend:
```bash
cd apps/api
swag init -g cmd/server/main.go   # Generate Swagger docs

cd ../..
pnpm generate                      # Generate TypeScript types + Zod schemas
```

**Generated Files:**
- `apps/api/docs/swagger.json` - OpenAPI spec
- `packages/types/src/generated/score.ts` - TypeScript types
- `packages/types/src/generated/score-schemas.ts` - Zod validation schemas

---

## Phase 2: Frontend Management Interface (Next.js)

### 2.1 API Client Setup

**File:** `apps/web/lib/api/score-api.ts`

**TanStack Query Hooks:**
```typescript
// Groups
useScoreGroups()                     // GET /score-groups
useScoreGroup(id)                    // GET /score-groups/:id
useScoreGroupTree(id)                // GET /score-groups/:id/tree
useAllScoreGroupTrees()              // GET /score-groups/tree
useCreateScoreGroup()                // POST /score-groups
useUpdateScoreGroup()                // PUT /score-groups/:id
useDeleteScoreGroup()                // DELETE /score-groups/:id

// Subgroups
useScoreSubgroups()
useScoreSubgroup(id)
useSubgroupsByGroup(groupId)
useCreateScoreSubgroup()
useUpdateScoreSubgroup()
useDeleteScoreSubgroup()

// Items
useScoreItems()
useScoreItem(id)
useItemsBySubgroup(subgroupId)
useCreateScoreItem()
useUpdateScoreItem()
useDeleteScoreItem()

// Levels
useScoreLevels()
useScoreLevel(id)
useLevelsByItem(itemId)
useCreateScoreLevel()
useUpdateScoreLevel()
useDeleteScoreLevel()
```

### 2.2 Score Management Page

**File:** `apps/web/app/(dashboard)/scores/page.tsx`

**Features:**
- Server-side data fetching with Next.js 15.1
- Breadcrumb navigation
- Action buttons (Create, Export, View Mindmap)
- Search/filter by name
- Bulk operations

**Layout:**
```tsx
<div className="space-y-6">
  <PageHeader title="Score Management" />

  <div className="flex justify-between">
    <SearchInput />
    <div className="flex gap-2">
      <Button onClick={() => router.push('/scores/mindmap')}>
        <Network className="mr-2" /> View Mindmap
      </Button>
      <Button onClick={() => setCreateGroupOpen(true)}>
        <Plus className="mr-2" /> Create Group
      </Button>
    </div>
  </div>

  <ScoreTreeView />
</div>
```

### 2.3 Score Tree View Component

**File:** `apps/web/components/scores/ScoreTreeView.tsx`

**Features:**
- Accordion-based tree (shadcn/ui Accordion)
- Expand/collapse all
- Inline editing
- Drag-and-drop reordering (dnd-kit library)
- Color-coded level badges
- Contextual actions (Edit, Delete, Add Child)

**Structure:**
```tsx
<Accordion type="multiple">
  {groups.map(group => (
    <AccordionItem key={group.id} value={group.id}>
      <AccordionTrigger>
        <GroupHeader group={group} />
      </AccordionTrigger>
      <AccordionContent>
        {group.subgroups.map(subgroup => (
          <SubgroupAccordion subgroup={subgroup}>
            {subgroup.items.map(item => (
              <ItemCard item={item}>
                <LevelsList levels={item.levels} />
              </ItemCard>
            ))}
          </SubgroupAccordion>
        ))}
      </AccordionContent>
    </AccordionItem>
  ))}
</Accordion>
```

### 2.4 Forms

**Files:**
- `apps/web/components/scores/forms/ScoreGroupForm.tsx`
- `apps/web/components/scores/forms/ScoreSubgroupForm.tsx`
- `apps/web/components/scores/forms/ScoreItemForm.tsx`
- `apps/web/components/scores/forms/ScoreLevelForm.tsx`

**Features:**
- React Hook Form + Zod validation (auto-generated schemas)
- shadcn/ui Form components
- Real-time validation
- Error messages
- Loading states
- Success toasts

**Example - ScoreItemForm:**
```tsx
const form = useForm<ScoreItemSchema>({
  resolver: zodResolver(scoreItemSchema), // Auto-generated
  defaultValues: item || {
    name: '',
    unit: '',
    unitConversion: '',
    points: 0,
    order: 0,
    subgroupId: '',
  }
})

// Fields:
// - Name (text)
// - Unit (text, optional)
// - Unit Conversion (textarea, optional)
// - Points (number, 0-100)
// - Order (number)
// - Parent Item (select, optional - for hierarchy)
```

**Example - ScoreLevelForm:**
```tsx
// Fields:
// - Level (select: 0-5)
// - Name (text, e.g., "55 a 70 (Ã“timo)")
// - Definition (textarea, optional)
// - Operator (select: =, >, >=, <, <=, between)
// - Lower Limit (text, conditional on operator)
// - Upper Limit (text, conditional on operator)
```

### 2.5 Additional Components

**File:** `apps/web/components/scores/ScoreLevelBadge.tsx`
- Color-coded badges for levels 0-5
- Tooltip with definition
- Icons for risk level

**File:** `apps/web/components/scores/ScoreItemCard.tsx`
- Display item with unit and points
- Show all levels in a compact view
- Quick edit/delete actions

**File:** `apps/web/components/scores/DeleteConfirmDialog.tsx`
- Confirmation dialog for deletions
- Show cascade impact (e.g., "This will delete 3 subgroups, 12 items")
- Prevent accidental deletions

---

## Phase 3: Mindmap Visualization (React Flow)

### 3.1 Mindmap Page

**File:** `apps/web/app/(dashboard)/scores/mindmap/page.tsx`

**Features:**
- Full-screen React Flow canvas
- Controls panel (zoom, fit view, collapse all)
- Export to PNG/SVG
- Legend for level colors
- Search to highlight nodes

**Layout:**
```tsx
<div className="h-screen flex flex-col">
  <MindmapHeader />

  <div className="flex-1 relative">
    <ReactFlow
      nodes={nodes}
      edges={edges}
      nodeTypes={customNodeTypes}
      onNodesChange={onNodesChange}
      onEdgesChange={onEdgesChange}
      fitView
    >
      <Background />
      <Controls />
      <MiniMap />
    </ReactFlow>
  </div>

  <MindmapLegend />
</div>
```

### 3.2 Custom Node Components

**Files:**
- `apps/web/components/scores/mindmap/GroupNode.tsx`
- `apps/web/components/scores/mindmap/SubgroupNode.tsx`
- `apps/web/components/scores/mindmap/ItemNode.tsx`
- `apps/web/components/scores/mindmap/LevelNode.tsx`

**GroupNode:**
```tsx
<div className="px-6 py-4 rounded-lg bg-primary text-primary-foreground shadow-lg">
  <div className="text-lg font-bold">{data.name}</div>
  <div className="text-sm opacity-80">{data.subgroupCount} subgroups</div>
  <Button size="sm" onClick={() => toggleExpand(data.id)}>
    {expanded ? 'Collapse' : 'Expand'}
  </Button>
</div>
```

**ItemNode:**
```tsx
<div className="px-4 py-3 rounded-md bg-card border shadow">
  <div className="font-semibold">{data.name}</div>
  <div className="text-xs text-muted-foreground">
    {data.unit} â€¢ {data.points} points
  </div>
  <div className="flex gap-1 mt-2">
    {data.levels.map(level => (
      <LevelIndicator key={level.id} level={level} />
    ))}
  </div>
</div>
```

**LevelNode:**
```tsx
<div className={cn(
  "px-3 py-2 rounded text-xs",
  getLevelColor(data.level)
)}>
  <div className="font-medium">Level {data.level}</div>
  <div>{data.name}</div>
  <div className="text-xs opacity-80">
    {data.lowerLimit} - {data.upperLimit}
  </div>
</div>
```

### 3.3 Layout Algorithm

**File:** `apps/web/components/scores/mindmap/useScoreMindmapLayout.ts`

**Algorithm:** Hierarchical tree layout (dagre or ELK)

```typescript
function buildMindmapLayout(scoreGroups: ScoreGroup[]) {
  const nodes: Node[] = []
  const edges: Edge[] = []

  let yOffset = 0

  scoreGroups.forEach(group => {
    // Add group node
    nodes.push({
      id: group.id,
      type: 'groupNode',
      position: { x: 0, y: yOffset },
      data: group
    })

    let subgroupOffset = 0
    group.subgroups.forEach(subgroup => {
      // Add subgroup node
      nodes.push({
        id: subgroup.id,
        type: 'subgroupNode',
        position: { x: 300, y: yOffset + subgroupOffset },
        data: subgroup
      })

      // Add edge from group to subgroup
      edges.push({
        id: `${group.id}-${subgroup.id}`,
        source: group.id,
        target: subgroup.id,
        type: 'smoothstep'
      })

      // Add items and levels...
      subgroupOffset += 200
    })

    yOffset += subgroupOffset + 100
  })

  return { nodes, edges }
}
```

**Features:**
- Auto-layout with proper spacing
- Collapse/expand branches (hide children)
- Smooth animations
- Pan and zoom with limits
- Fit view on load

### 3.4 Color Scheme for Levels

```typescript
const LEVEL_COLORS = {
  0: { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-900' },      // Critical
  1: { bg: 'bg-orange-100', border: 'border-orange-500', text: 'text-orange-900' }, // Very Low/High
  2: { bg: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-900' }, // Suboptimal
  3: { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-900' },    // Borderline
  4: { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-900' }, // Good
  5: { bg: 'bg-emerald-100', border: 'border-emerald-500', text: 'text-emerald-900' }, // Optimal
}
```

### 3.5 Export Functionality

```typescript
function exportMindmapToPNG() {
  const reactFlowInstance = useReactFlow()
  const { getNodes } = reactFlowInstance

  // Use html-to-image library
  toPng(document.querySelector('.react-flow'), {
    filter: (node) => {
      // Exclude controls and background
      return !node.classList?.contains('react-flow__controls')
    }
  }).then(dataUrl => {
    const a = document.createElement('a')
    a.setAttribute('download', `score-mindmap-${Date.now()}.png`)
    a.setAttribute('href', dataUrl)
    a.click()
  })
}
```

---

## Phase 4: Data Import (CSV to Database)

### 4.1 Import Script

**File:** `scripts/import_scores_from_csv.py` or `scripts/import_scores.go`

**Input:** CSV files with score data (already available in repo)

**Process:**
1. Parse CSV files
2. Create ScoreGroups
3. Create ScoreSubgroups
4. Create ScoreItems with units and points
5. Create 6 ScoreLevels per item (parsing level definitions)

**Example CSV format:**
```csv
Group,Subgroup,Item,Unit,Conversion,Points,Level0,Level1,Level2,Level3,Level4,Level5
Hemograma Completo,SÃ©rie Vermelha,Hemoglobina - Homens,g/dL,1 g/dL = 10 g/L,20,<12 (Anemia severa),12 a 13 (Anemia leve),>17 (Policitemia),13 a 13.9 (SubÃ³timo),15.1 a 17 (Alto-normal),14.0 a 15.0 (Ã“timo)
```

### 4.2 API Endpoint for Bulk Import

```
POST /api/v1/score-groups/import
Content-Type: multipart/form-data

Body: { file: scores.csv }
```

**Handler:**
- Parse CSV
- Validate data
- Transaction-based import (rollback on error)
- Return import summary (created counts)

---

## Dependencies

### Backend (Go)
- Already installed âœ…
  - Fiber v2.53
  - GORM v1.25
  - UUID library
  - Validator v10
  - Swag (OpenAPI generation)

### Frontend (Next.js)
**New dependencies to install:**
```bash
pnpm add -w reactflow
pnpm add -w @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
pnpm add -w html-to-image
```

**Already available:**
- TanStack Query âœ…
- React Hook Form âœ…
- Zod âœ…
- shadcn/ui âœ…
- Tailwind CSS âœ…

---

## Testing Strategy

### Backend Tests
```bash
cd apps/api
go test ./internal/repository -v    # Repository tests
go test ./internal/services -v      # Service tests
go test ./internal/handlers -v      # Handler tests
```

**Test Coverage:**
- Repository: CRUD operations, cascade deletes, soft deletes
- Service: Business logic, validation, tree building
- Handlers: HTTP endpoints, auth middleware, error responses

### Frontend Tests
```bash
cd apps/web
pnpm test                            # Unit tests (Vitest)
pnpm test:e2e                        # E2E tests (Playwright)
```

**Test Coverage:**
- API hooks: Query/mutation behavior
- Forms: Validation, submission, error handling
- Tree view: Expand/collapse, reordering
- Mindmap: Node rendering, layout, interactions

---

## Security & Performance

### Security
- **Admin only:** All mutations require `admin` role
- **Input validation:** Zod on frontend, Go validator on backend
- **Audit logging:** Track all score modifications
- **Soft deletes:** Prevent data loss
- **CSRF protection:** Built into Next.js forms

### Performance
- **Database indexes:** All FKs indexed âœ…
- **Pagination:** Large lists paginated (100 items/page)
- **React Query caching:** 5min stale time for score data
- **Optimistic updates:** Instant UI feedback
- **Tree loading:** Load on-demand (lazy load deep levels)

---

## Rollout Plan

1. **Phase 1 (Days 1-2):** Backend API implementation
2. **Phase 2 (Days 3-4):** Management interface
3. **Phase 3 (Days 5-6):** Mindmap visualization
4. **Phase 4 (Day 7):** Data import + testing
5. **Phase 5 (Day 8):** Polish, bug fixes, documentation

---

## Success Criteria

âœ… **Backend:**
- All CRUD endpoints working
- Swagger docs complete
- TypeScript types generated
- Response time < 200ms (p95)

âœ… **Management Interface:**
- Full CRUD operations functional
- Forms validated properly
- Drag-and-drop reordering working
- Mobile responsive

âœ… **Mindmap:**
- Visualizes full hierarchy
- Smooth pan/zoom
- Export to PNG works
- No performance issues with 100+ nodes

âœ… **Data:**
- All CSV data imported successfully
- No data loss
- Audit trail present

---

**Next Step:** Start Phase 1 - Backend API Implementation

**Last Updated:** January 24, 2026
